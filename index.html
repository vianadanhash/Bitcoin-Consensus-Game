<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Class: Multicuenta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #0f172a; color: white; image-rendering: pixelated; }
        .pixel-border { border: 4px solid #fff; box-shadow: 6px 6px 0px #000; }
        .btn-pixel:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #fbbf24; border: 2px solid #000; }
    </style>
</head>
<body class="p-4">

    <header class="text-center mb-6">
        <h1 class="text-xl text-yellow-400 mb-2">BITCOIN CLASS: CONSENSO</h1>
        <div id="display-sala" class="text-[10px] text-blue-400 mb-4">SALA: ESPERANDO...</div>
        <div id="status-ronda" class="bg-red-600 inline-block px-4 py-2 text-[8px] pixel-border border-black">
            CARGANDO...
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        <div class="bg-blue-900 p-6 pixel-border border-blue-400">
            <h2 class="text-[8px] mb-4">MI BILLETERA</h2>
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-gray-800 border-2 border-white flex items-center justify-center text-xl">üëæ</div>
                <div>
                    <p class="text-[8px] text-gray-300" id="my-name">...</p>
                    <p class="text-lg text-green-400 mt-2" id="my-balance">0 BTC</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-6 pixel-border border-yellow-500">
            <h2 class="text-[8px] mb-4 text-yellow-400">ENVIAR MONEDAS</h2>
            <div class="space-y-4">
                <select id="destinatario" class="w-full bg-black border-2 border-gray-600 p-2 text-[8px] text-white">
                    <option value="">Cargando...</option>
                </select>
                <input id="monto" type="number" placeholder="CANTIDAD" class="w-full bg-black border-2 border-gray-600 p-2 text-[8px] text-white">
                <button onclick="enviarTransaccion()" class="w-full bg-green-600 p-3 text-[8px] btn-pixel border-2 border-black">
                    ENVIAR AL LIBRO
                </button>
            </div>
        </div>

        <div class="bg-black p-6 pixel-border border-purple-500">
            <h2 class="text-[8px] mb-4 text-purple-400">LIBRO P√öBLICO (MEMPOOL)</h2>
            <div id="ledger" class="space-y-4 h-64 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="panel-profe" class="mt-8 text-center hidden">
        <button onclick="cambiarRonda(1)" class="bg-red-700 p-2 text-[8px] mx-1 pixel-border border-black">Ronda 1</button>
        <button onclick="cambiarRonda(2)" class="bg-purple-700 p-2 text-[8px] mx-1 pixel-border border-black">Ronda 2</button>
        <button onclick="limpiarDatos()" class="bg-gray-700 p-2 text-[8px] mx-1 pixel-border border-black">Borrar Todo</button>
    </div>

    <script>
      
        const firebaseConfig = {
            apiKey: "AIzaSyBJGxv-FEAn6G58GnuTjrls_0ovn4WCN7Q",
            authDomain: "bitcoinclassconsensus.firebaseapp.com",
            databaseURL: "https://bitcoinclassconsensus-default-rtdb.firebaseio.com",
            projectId: "bitcoinclassconsensus",
            storageBucket: "bitcoinclassconsensus.firebasestorage.app",
            messagingSenderId: "890839108801",
            appId: "1:890839108801:web:c336f917c8d43ca5549840"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // === 2. INICIO DE SALA Y USUARIO ===
        let roomCode = prompt("C√ìDIGO DE SALA (ej: CLASE01)").toUpperCase().trim();
        if(!roomCode) location.reload();
        
        let myName = prompt("TU NOMBRE (Escribe 'Profe' para admin)") || "Anon";
        let myId = myName.toLowerCase().replace(/\s/g, ''); 
        let currentRound = 1;

        const roomRef = db.ref('rooms/' + roomCode);
        document.getElementById('display-sala').innerText = "SALA: " + roomCode;
        document.getElementById('my-name').innerText = myName;

        if(myId === 'profe' || myId === 'profesor') {
            document.getElementById('panel-profe').classList.remove('hidden');
        }

        // Registrar usuario
        const userRef = roomRef.child('users/' + myId);
        userRef.once('value', snapshot => {
            if(!snapshot.exists()) {
                userRef.set({ nombre: myName, saldo: Math.floor(Math.random() * 400) + 100 });
            }
        });

        // Escuchar mi saldo
        userRef.child('saldo').on('value', snap => {
            document.getElementById('my-balance').innerText = (snap.val() || 0) + " BTC";
        });

        // Escuchar ronda
        roomRef.child('estado/ronda').on('value', snap => {
            currentRound = snap.val() || 1;
            const s = document.getElementById('status-ronda');
            s.innerText = currentRound === 1 ? "RONDA 1: CONTADOR CENTRAL" : "RONDA 2: CONSENSO";
            s.className = currentRound === 1 ? "bg-red-600 inline-block px-4 py-2 text-[8px] pixel-border border-black" : "bg-purple-600 inline-block px-4 py-2 text-[8px] pixel-border border-black";
        });

        // Lista de receptores
        roomRef.child('users').on('value', snap => {
            const sel = document.getElementById('destinatario');
            sel.innerHTML = '<option value="">Seleccionar receptor...</option>';
            snap.forEach(u => {
                if(u.key !== myId) sel.innerHTML += `<option value="${u.key}">${u.val().nombre}</option>`;
            });
        });

        // === 3. ACCIONES ===
        function enviarTransaccion() {
            const dest = document.getElementById('destinatario').value;
            const monto = parseInt(document.getElementById('monto').value);
            if(!dest || !monto) return alert("Completa los datos");
            
            roomRef.child('transactions').push({
                de: myId, deNombre: myName, para: dest, monto: monto,
                estado: 'pendiente', votosFavor: 0, votosContra: 0
            });
            document.getElementById('monto').value = '';
        }

        // === 4. EL LIBRO (LEDGER) ===
        roomRef.child('transactions').on('value', snapshot => {
            const ledger = document.getElementById('ledger');
            ledger.innerHTML = '';
            snapshot.forEach(child => {
                const tx = child.val();
                const txId = child.key;

                // Ver saldo del emisor en tiempo real
                roomRef.child('users/' + tx.de + '/saldo').once('value', sSnap => {
                    const saldoEmisor = sSnap.val() || 0;
                    const color = tx.estado === 'aprobada' ? 'border-green-500' : (tx.estado === 'rechazada' ? 'border-red-500' : 'border-yellow-500');
                    
                    let html = `
                        <div class="border-l-4 ${color} pl-2 py-2 bg-gray-900 mb-2 text-[7px]">
                            <p class="text-gray-500">TX#${txId.slice(-4)} [${tx.estado}]</p>
                            <p>${tx.deNombre} ‚ûî ${tx.para}: <span class="text-green-400">${tx.monto} BTC</span></p>
                            <p class="mt-1 text-gray-400">Saldo emisor: <span class="${saldoEmisor < tx.monto ? 'text-red-500' : ''}">${saldoEmisor} BTC</span></p>
                    `;

                    if(tx.estado === 'pendiente') {
                        if(currentRound === 1 && (myId === 'profe' || myId === 'profesor')) {
                            html += `<div class="mt-2 flex space-x-1">
                                <button onclick="resolverTx('${txId}','aprobada','${tx.de}','${tx.para}',${tx.monto})" class="bg-green-700 p-1 border border-black">OK</button>
                                <button onclick="resolverTx('${txId}','rechazada')" class="bg-red-700 p-1 border border-black">X</button>
                            </div>`;
                        } else if(currentRound === 2) {
                            html += `<div class="mt-2 flex items-center space-x-2">
                                <button onclick="votar('${txId}','favor')" class="bg-blue-700 p-1">üëç</button>
                                <button onclick="votar('${txId}','contra')" class="bg-pink-700 p-1">üëé</button>
                                <span>S:${tx.votosFavor||0} N:${tx.votosContra||0}</span>
                            </div>`;
                        }
                    }
                    html += `</div>`;
                    ledger.insertAdjacentHTML('afterbegin', html);
                });
            });
        });

        function resolverTx(id, estado, de, para, monto) {
            if(estado === 'aprobada') {
                roomRef.child('users/'+de+'/saldo').transaction(s => s - monto);
                roomRef.child('users/'+para+'/saldo').transaction(s => s + monto);
            }
            roomRef.child('transactions/'+id).update({estado: estado});
        }

        function votar(id, tipo) {
            roomRef.child('transactions/'+id).transaction(tx => {
                if(!tx) return tx;
                if(tipo === 'favor') tx.votosFavor = (tx.votosFavor||0)+1;
                else tx.votosContra = (tx.votosContra||0)+1;
                
                if(tx.votosFavor >= 3) { // Umbral de 3 votos
                    tx.estado = 'aprobada';
                    roomRef.child('users/'+tx.de+'/saldo').transaction(s => s - tx.monto);
                    roomRef.child('users/'+tx.para+'/saldo').transaction(s => s + tx.monto);
                } else if(tx.votosContra >= 3) {
                    tx.estado = 'rechazada';
                }
                return tx;
            });
        }

        function cambiarRonda(n) { roomRef.child('estado/ronda').set(n); }
        function limpiarDatos() { if(confirm("¬øBorrar sala?")) roomRef.remove(); location.reload(); }
    </script>
</body>
</html>

    </script>
</body>

</html>
